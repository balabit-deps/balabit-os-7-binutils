From aa4a8c2a2a67545e90c877162c53cc9de42dc8b4 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Tue, 24 Apr 2018 16:31:27 +0100
Subject: [PATCH] Fix an illegal memory access when copying a PE format file
 with corrupt debug information.

	PR 23110
	* peXXigen.c (_bfd_XX_bfd_copy_private_bfd_data_common): Check for
	a negative PE_DEBUG_DATA size before iterating over the debug data.
---
 bfd/ChangeLog  |    6 +
 bfd/peXXigen.c |    9 +
 bfd/po/bfd.pot | 5631 +++++++++++++++++++++++-------------------------
 3 files changed, 2662 insertions(+), 2984 deletions(-)

#diff --git a/bfd/ChangeLog b/bfd/ChangeLog
#index 3c26f8a5c77..32cd8933c2c 100644
#--- a/bfd/ChangeLog
#+++ b/bfd/ChangeLog
#@@ -1,3 +1,9 @@
#+2018-04-24  Nick Clifton  <nickc@redhat.com>
#+
#+	PR 23110
#+	* peXXigen.c (_bfd_XX_bfd_copy_private_bfd_data_common): Check for
#+	a negative PE_DEBUG_DATA size before iterating over the debug data.
#+
# 2018-04-23  Alan Modra  <amodra@gmail.com>
# 
# 	* elf-linux-core.h: Revert last change.
--- a/bfd/peXXigen.c
+++ b/bfd/peXXigen.c
@@ -2991,6 +2991,15 @@ _bfd_XX_bfd_copy_private_bfd_data_common
 				  bfd_get_section_size (section) - (addr - section->vma));
 	      return FALSE;
 	    }
+	  /* PR 23110.  */
+	  else if (ope->pe_opthdr.DataDirectory[PE_DEBUG_DATA].Size < 0)
+	    {
+	      /* xgettext:c-format */
+	      _bfd_error_handler
+		(_("%pB: Data Directory size (%#lx) is negative"),
+		 obfd, ope->pe_opthdr.DataDirectory[PE_DEBUG_DATA].Size);
+	      return FALSE;
+	    }
 
 	  for (i = 0; i < ope->pe_opthdr.DataDirectory[PE_DEBUG_DATA].Size
 		 / sizeof (struct external_IMAGE_DEBUG_DIRECTORY); i++)
